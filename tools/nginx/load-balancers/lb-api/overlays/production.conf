# =================================================================================================
# Production Overlay - API Load Balancer
# =================================================================================================

access_log /dev/stdout json_combined;
error_log /dev/stderr warn;

# Rate limiting zones for API
limit_req_zone $binary_remote_addr zone=api_general:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=api_auth:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=api_upload:10m rate=5r/m;

# Connection limit
limit_conn_zone $binary_remote_addr zone=api_conn_limit:10m;

server {
    listen 8080;
    server_name _;
    
    add_header X-LB-Node "lb-api-prod" always;
    
    # Apply connection limits
    limit_conn api_conn_limit 20;
    
    # Authentication with strict rate limiting
    location /api/auth/ {
        limit_req zone=api_auth burst=5 nodelay;
        
        proxy_pass http://api_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Strict timeouts for auth
        proxy_connect_timeout 15s;
        proxy_send_timeout 15s;
        proxy_read_timeout 15s;
    }
    
    # File uploads with rate limiting
    location /api/upload/ {
        limit_req zone=api_upload burst=2 nodelay;
        
        client_max_body_size 50M;
        
        proxy_pass http://api_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_request_buffering off;
    }
    
    # General API endpoints
    location /api/ {
        limit_req zone=api_general burst=100 nodelay;
        
        proxy_pass http://api_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
