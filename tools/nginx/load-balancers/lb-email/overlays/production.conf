# =================================================================================================
# Production Overlay - Email Load Balancer
# =================================================================================================

access_log /dev/stdout json_combined;
error_log /dev/stderr warn;

# Rate limiting for email endpoints
limit_req_zone $binary_remote_addr zone=email_send:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=email_general:10m rate=20r/s;

# Connection limit
limit_conn_zone $binary_remote_addr zone=email_conn_limit:10m;

server {
    listen 8080;
    server_name _;
    
    add_header X-LB-Node "lb-email-prod" always;
    
    # Apply connection limits
    limit_conn email_conn_limit 10;
    
    # Strict rate limiting for email sending
    location /email/send {
        limit_req zone=email_send burst=3 nodelay;
        
        client_max_body_size 25M;
        
        proxy_pass http://email_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Production timeouts for email sending
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # General email endpoints
    location /email/ {
        limit_req zone=email_general burst=30 nodelay;
        
        proxy_pass http://email_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Webhooks - no rate limiting (external services)
    location /email/webhook {
        # Verify webhook signature if possible
        # This is handled by the application layer
        
        proxy_pass http://email_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Webhook-Signature $http_x_webhook_signature;
    }
}
